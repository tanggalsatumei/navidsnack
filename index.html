<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title id="site-title">Navid Snack</title>
  <meta id="meta-desc" name="description" content="Navid Snack - Keripik Pisang & Olahan" />
  <meta id="meta-keywords" name="keywords" content="" />
  <link id="favicon" rel="icon" href="/assets/favicon.png" type="image/png">

  <!-- Swiper CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"/>

  <style>
    /* (CSS same as versi sebelumnya - singkatkan agar fokus ke JS) */
    :root{--primary:#121212;--accent:#c59b58;--bg:#fff;--card:#fff;--text:#222;--muted:#777;--border:#e9e9e9;--maxw:1200px;--headerTop:0px}
    body.dark{--primary:#0b0b0b;--bg:#0a0a0a;--card:#111;--text:#eaeaea;--muted:#a1a1a1;--border:#222}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none} img{max-width:100%;display:block}
    header{position:fixed; top:var(--headerTop); left:0; right:0; background:var(--primary); color:var(--accent); z-index:10000; box-shadow:0 2px 10px rgba(0,0,0,.15)}
    .header-bar{max-width:var(--maxw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px;gap:12px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo img{width:36px;height:36px;border-radius:6px}
    nav ul{display:flex;gap:14px;list-style:none;padding:0;margin:0}
    nav a{font-weight:700;color:var(--accent)}
    main, #hero{margin-top:calc(76px + var(--headerTop))}
    .btn{background:none;color:var(--accent);border:1px solid var(--accent);padding:.45rem .7rem;border-radius:8px;cursor:pointer}
    .slide-content{display:flex;gap:30px;align-items:center;max-width:1000px;padding:40px;background:#fff;color:#333;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .products-grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:600px){ .products-grid{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:900px){ .products-grid{grid-template-columns:repeat(3,1fr)} }
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--card);display:flex;flex-direction:column;align-items:center;position:relative}
    .img-wrapper img{width:100%;display:block;aspect-ratio:1/1;object-fit:cover;border-radius:10px}
    .promo-label{position:absolute;top:10px;left:10px;background:red;color:#000;padding:6px 8px;font-weight:800;border-radius:8px;display:none;z-index:8;font-size:.85rem}
    .countdown-overlay{position:absolute;bottom:0;left:0;width:100%;background:rgba(255,215,0,0.98);color:#000;font-weight:800;padding:6px 6px;text-align:center;border-bottom-left-radius:10px;border-bottom-right-radius:10px;z-index:9;display:none}
    .price{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:6px}
    .price .old{text-decoration:line-through;color:gray;display:none}
    .price .new{color:#d32f2f;font-weight:900}
    .blog-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .toast-buy{position:fixed;left:16px;bottom:16px;background:rgba(0,0,0,0.8);color:#fff;padding:10px 14px;border-radius:10px;z-index:30000;display:none}
  </style>
</head>
<body>

  <!-- Loading -->
  <div id="loadingOverlay" style="display:none"><div class="spinner"></div></div>

  <!-- Promo marquee -->
  <div id="promo-bar" class="promo-marquee" style="display:none">
    <div class="marq" id="promo-text">ðŸ”¥ Promo Spesial ðŸ”¥</div>
  </div>

  <!-- Offcanvas -->
  <div id="offcanvasLeft" class="offcanvas-left" aria-hidden="true">
    <button class="offcanvas-close" id="offLeftClose">Ã—</button>
    <nav>
      <ul>
        <li><a href="#hero" class="off-link">Beranda</a></li>
        <li><a href="#products" class="off-link">Produk</a></li>
        <li><a href="#gallery" class="off-link">Galeri</a></li>
        <li><a href="#blog">Pemesanan Cepat</a></li>
        <li><a href="#contact" class="off-link">Kontak</a></li>
      </ul>
    </nav>
  </div>

  <!-- Header -->
  <header>
    <div class="header-bar">
      <div style="display:flex;align-items:center;gap:12px">
        <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">â˜°</button>
        <div class="logo">
          <img id="site-logo" src="/assets/logo.png" alt="Logo Toko">
          <div>
            <a href="/" id="brand-name" style="color:var(--accent);text-decoration:none">Navid Snack</a>
            <div id="brand-sub" style="font-size:.85rem;color:var(--muted)"></div>
          </div>
        </div>  
      </div>

      <nav>
        <ul id="navList">
          <li><a href="#hero">Beranda</a></li>
          <li><a href="#products">Produk</a></li>
          <li><a href="#gallery">Galeri</a></li>
          <li><a href="#blog">Pemesanan Cepat</a></li>
          <li><a href="#contact">Kontak</a></li>
        </ul>
      </nav>

      <div style="display:flex;gap:10px;align-items:center;position:relative">
        <button id="darkToggle" class="btn" title="Toggle Dark Mode">ðŸŒ™</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section id="hero">
    <div class="swiper swiper-hero" id="swiperHero">
      <div class="swiper-wrapper" id="slidesContainer"></div>
      <div class="hero-overlay"></div>
      <div class="swiper-pagination"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>
  </section>

  <main>
    <!-- Products -->
    <section id="products">
      <h2 class="section-title">Produk Unggulan</h2>
      <div id="productsGrid" class="products-grid">
        <div class="card skeleton" style="height:320px"></div>
        <div class="card skeleton" style="height:320px"></div>
        <div class="card skeleton" style="height:320px"></div>
      </div>
    </section>

    <!-- Gallery -->
    <section id="gallery" class="gallery-section">
      <h2 class="section-title">Galeri</h2>
      <div class="swiper" id="gallerySwiper">
        <div class="swiper-wrapper" id="galleryGrid">
          <div class="swiper-slide skeleton" style="height:180px"></div>
        </div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
    </section>

    <!-- Testimonials -->
    <section id="testimonials" class="testi-section">
      <h2 class="section-title">Testimoni</h2>
      <div class="swiper" id="testiSwiper">
        <div class="swiper-wrapper" id="testiGrid">
          <div class="swiper-slide skeleton" style="height:160px"></div>
        </div>
        <div class="swiper-pagination"></div>
      </div>
    </section>

    <section id="blog">
      <h2 class="section-title">Pemesanan Cepat</h2>
      <div id="blogList" class="blog-grid">
        <p>Sedang memuat menu pemesanan cepat...</p>
      </div>
    </section>

    <!-- Video grid -->
    <section id="video">
      <h2 class="section-title">Proses Produksi</h2>
      <div class="video-grid">
        <div class="video-wrapper" id="videoWrapper">
          <iframe src="https://www.youtube.com/embed/B5njr5BoGo8" loading="lazy" allowfullscreen title="Video Produksi"></iframe>
        </div>
        <aside class="video-side">
          <h3>Kenapa Kami?</h3>
          <ul style="margin:0;padding-left:18px;line-height:1.6">
            <li>Bahan baku pilihan</li>
            <li>Proses higienis</li>
            <li>Rasa konsisten</li>
            <li>Harga UMKM bersahabat</li>
          </ul>
        </aside>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer id="contact">
    <div class="footer-inner">
      <div id="popular-articles">
        <h4>Menu Cepat</h4>
        <ul id="popularList" style="padding-left:18px; line-height:1.6"></ul>
      <div id="footer-map"></div>
      </div>

      <div>
        <h3 id="footer-title">Navid Snack</h3>
        <p id="footer-desc">Produsen snack & minuman dari Lamongan.</p>
        <p><strong>Alamat:</strong> <span id="footer-address">-</span></p>
        <p><strong>Jam Buka:</strong> <span id="footer-hours">-</span></p>
        <p><strong>Kontak:</strong> <a id="footer-wa" href="#" target="_blank" rel="noopener">WhatsApp</a></p>
        <p style="margin-top:8px">
          <a href="#" id="tosLink" style="color:var(--accent);text-decoration:underline;cursor:pointer">Syarat & Ketentuan</a> Â·
          <a href="#" id="privacyLink" style="color:var(--accent);text-decoration:underline;cursor:pointer">Kebijakan Privasi</a> Â·
          <a href="#" id="refundLink" style="color:var(--accent);text-decoration:underline;cursor:pointer">Kebijakan Pengembalian</a>
        </p>
      </div>
    </div>
  </footer>

  <!-- Floating controls -->
  <div class="controls-float" aria-hidden="false">
    <div id="scrollTopBtn" class="control-btn scroll-top" title="Kembali ke atas">â¬†</div>
    <div id="cartFloatWrap" style="display:flex;flex-direction:column;align-items:center;gap:8px">
      <div id="cartFloat" class="control-btn floating-cart" title="Keranjang">ðŸ›’
        <span id="cartBadge" class="cart-badge" style="display:none">0</span>
      </div>
    </div>
    <a id="waFloat" class="wa-btn" href="#" target="_blank" rel="noopener" title="WhatsApp">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="width:56px;height:56px">
    </a>
  </div>

  <!-- Cart panel -->
  <aside id="cartPanel" class="cart-panel" aria-hidden="true">
    <button id="closeCartPanel" class="close-cart" title="Tutup">Ã—</button>
    <h3 style="margin-top:8px">Review Pesanan</h3>
    <div id="cartItemsList" style="overflow:auto;max-height:60vh"></div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Total:</strong><div id="cartTotal">Rp 0</div>
    </div>
    <p class="note-ongkir">* Harga belum termasuk ongkir dari Lamongan</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="clearCart" class="btn">Kosongkan</button>
      <button id="checkoutBtn" class="btn" style="background:var(--accent);border:none;color:#000">Checkout via WA</button>
    </div>
  </aside>

  <!-- Zoom overlay -->
  <div id="zoomOverlay" class="zoom-overlay" aria-hidden="true" style="display:none">
    <button id="zoomClose" class="zoom-close" title="Tutup">âœ•</button>
    <img id="zoomImg" class="zoom-img" alt="Preview gambar diperbesar">
    <div class="zoom-toolbar">
      <button id="zoomOut">âˆ’</button>
      <button id="zoomReset">100%</button>
      <button id="zoomIn">+</button>
    </div>
  </div>

  <!-- Purchase toast -->
  <div id="purchaseToast" class="toast-buy" role="status" aria-live="polite"></div>

  <!-- Swiper JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

  <!-- Load DB (data.js) -->
  <script src="data.js"></script>

  <script>
  /* ========= CONFIG ========= */
  const API_URL = ""; // tetap agar kode lama aman
  const API_TOKEN = "";
  const LOCALE = "id-ID";
  const TZONE = 'Asia/Jakarta';
  const CACHE_KEY = "sabiq_cache_all";
  const CACHE_TTL = 5 * 60 * 1000; // 5 menit
  /* ========================= */

  const $ = (s, ctx=document) => ctx.querySelector(s);
  const $$ = (s, ctx=document) => Array.from((ctx||document).querySelectorAll(s));
  const pad = n => String(n).padStart(2,'0');
  function showLoading(show=true){ $('#loadingOverlay')?.classList.toggle('show', !!show); }
  function formatRupiah(v){ if(v==null||v==='') return '-'; const n=Number(String(v).replace(/\D/g,'')); if(isNaN(n)) return v; return n.toLocaleString(LOCALE); }
  function safeParseJSON(t){ try{return JSON.parse(t);}catch(e){return null;} }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  /* Time utilities (omitted for brevity) - keep original functions as in your file */
  // -- include getTZPartsNow, getTZOffsetMinutes, normalizeHM, parseHM, tryParseDateTime, tzWallClockToEpochMs, getPromoStatus, formatHMS --

  // (for brevity in this preview file, assume the time utilities are copied here exactly as original)

  /* ====== App state & helpers (unchanged names) ====== */
  let SETTINGS = {};
  let PRODUCTS = [], SLIDES = [], GALLERY = [], TESTIS = [];
  let cart = [];
  let heroSwiper, gallerySwiper, testiSwiper;

  // --- adapt fetchAll to accept local DB (data.js)
  async function fetchAll(){
    if(window.DB){
      // if DB is already structured like spreadsheet export, return it
      return window.DB;
    }
    // fallback: try old API
    const url = `${API_URL}?sheet=all&token=${encodeURIComponent(API_TOKEN)}`;
    const res = await fetch(url, {cache:"no-cache"});
    const j = await res.json();
    if(j && !j.error) return j;
    throw new Error(j && j.error ? j.error : "Gagal memuat data");
  }

  async function getAllData(opts={}){
    // keep cache logic, but always use DB when present
    if(window.DB) return window.DB;
    const force = !!opts.force;
    const data = await fetchAll();
    return data;
  }

  // rowsToMap and normalize functions remain unchanged (use your original ones)
  // For brevity, include simplified versions here but keep names so other code works
  function rowsToMap(rows){
    const m={};
    (rows||[]).forEach(r=>{
      if(r.key != null && r.value != null){
        m[String(r.key).trim().toLowerCase()] = r.value;
      } else {
        const ks = Object.keys(r||{});
        if(ks.length>=2 && r[ks[0]] != null){
          m[String(r[ks[0]]).trim().toLowerCase()] = r[ks[1]];
        }
      }
    });
    return m;
  }

  const getAny = (r, keys=[]) => { for(const k of keys){ if(r[k]!==undefined && r[k]!=='' && r[k]!==null) return r[k]; } return ''; };

  function normalizeSlides(rows){
    return (rows||[]).map(r=>({
      bg: getAny(r,['bg','bg_image','bg image','bg_image_url','background']) || getAny(r,['bg']) || '',
      img: getAny(r,['image','image_url','gambar','gbr','gbr image','img']) || '',
      alt: getAny(r,['altslider','alt slider','alt_slider','alt','alt_text']) || '',
      title: getAny(r,['judulslider','judul slider','title','judul']) || '',
      caption: getAny(r,['ket_slider','caption','keterangan','desc']) || '',
      btn_text: getAny(r,['tombol','button','btn_text']) || 'Lihat',
      btn_link: getAny(r,['tombol_link','button_link','btn_link','link']) || '#'
    }));
  }

  function normalizeProducts(rows){
    return (rows||[]).map((r,i)=>{
      const tglStart = getAny(r,['tglpromostart','tgl_start','tanggalmulai']) || '';
      const tglEnd   = getAny(r,['tglpromoend','tgl_end','tanggalselesai']) || '';
      const jamStart = getAny(r,['jampromostart','jam_start','jammulai']) || '';
      const jamEnd   = getAny(r,['jampromoend','jam_end','jamselesai']) || '';

      let promostart='', promoend='';
      if(tglStart && !tglEnd) {
        promostart = `${tglStart} ${jamStart||'00:00'}`;
        promoend   = `${tglStart} ${jamEnd||'23:59'}`;
      } else if(!tglStart && !tglEnd) {
        promostart = jamStart || '';
        promoend   = jamEnd || '';
      } else {
        promostart = `${tglStart||''} ${jamStart||'00:00'}`.trim();
        promoend   = `${tglEnd||tglStart||''} ${jamEnd||'23:59'}`.trim();
      }

      const rawStatus = String(getAny(r,['aktif','status','is_active'])).trim().toLowerCase();
      const aktif = !(rawStatus === 'no' || rawStatus === 'n' || rawStatus === 'false' || rawStatus === '0');

      return {
        id: getAny(r,['id','ID','Id']) || 'p'+i,
        nama: getAny(r,['namaproduk','nama produk','nama_produk','judul produk','judulproduk','produk','nama','name','productname','product_name']) || 'Produk',
        gbr: getAny(r,['gbrproduk','gambar produk','gambar_produk','gbr','gambar','image','gbr image']) || '',
        alt: getAny(r,['altproduk','alt_produk','alt produk','alt','alt_text','alt_gambar','alt image']) || '',
        hargaawal: getAny(r,['hargaawal','harga awal','harga','price']) || '',
        hargadiskon: getAny(r,['hargadiskon','harga diskon','hargadisc','diskon']) || '',
        promostart,
        promoend,
        desc: getAny(r,['deskripsi','description','desc','keterangan','keterangan produk']) || '',
        aktif: aktif
      };
    });
  }

  function normalizeGallery(rows){
    return (rows||[]).map(r=>({ url: getAny(r,['gambar_url','image','url','gambar','link']) || getAny(r,['url']) || '', alt: getAny(r,['altgaleri','alt_gallery','alt','alt_text']) || '' }));
  }

  function normalizeTestis(rows){
    return (rows||[]).map(r=>({ nama:getAny(r,['nama','name'])||'', jabatan:getAny(r,['jabatan','role'])||'', gambar:getAny(r,['gambar_url','gambar','image'])||'', alt:getAny(r,['alt','alt_text','alt_gambar'])||getAny(r,['nama','name']) }));
  }

  function applySettings(s){
    if(!s) return;
    SETTINGS = s;
    if(s['site title']||s.site_title) { const title = s['site title']||s.site_title; document.title = title; $('#brand-name').textContent = title; }
    if(s.logo) $('#site-logo').src = s.logo;
    if(s.icon) $('#favicon').href = s.icon;
    if(s.warna) document.documentElement.style.setProperty('--accent', s.warna);
    if(s.textpromo) $('#promo-text').textContent = s.textpromo;

    if(s.wa){
      const waLink = `https://wa.me/${s.wa}?text=${encodeURIComponent(s['wa message']||s.wa_message||'')}`;
      $('#waFloat').href = waLink;
      $('#footer-wa').href = waLink;
      $('#footer-wa').textContent = s.wa;
    }
    if(s.alamat) $('#footer-address').textContent = s.alamat;
    if(s['jam buka']) $('#footer-hours').textContent = s['jam buka'];
    if(s.deskripsi) $('#footer-desc').textContent = s.deskripsi;

    if(s.maps){
      const holder = $('#footer-map'); holder.innerHTML = '';
      const iframe = document.createElement('iframe'); iframe.loading = 'lazy'; iframe.src = s.maps; iframe.title = 'Peta Lokasi'; holder.appendChild(iframe);
    }

    if(s.video_embed) $('#videoWrapper').innerHTML = `<iframe src="${s.video_embed}" frameborder="0" allowfullscreen loading="lazy" title="Video Produksi"></iframe>`;

    // keywords meta
    if(s.keywords && Array.isArray(s.keywords)){
      $('#meta-keywords').setAttribute('content', s.keywords.join(', '));
    }
  }

  /* ===== renderers (hero, products, gallery, testi) - same as original, with minor tweaks to use DB assets path */
  function renderHero(){
    const container = $('#slidesContainer'); container.innerHTML = '';
    if(!SLIDES.length) SLIDES = [{bg:'/assets/hero1.jpg', img:'/assets/keripik.jpg', title:'Navid Snack', caption:'Snack khas Lamongan', btn_text:'Pesan', btn_link:'#products', alt:'Navid'}];
    SLIDES.forEach(s=>{
      const slide = document.createElement('div'); slide.className='swiper-slide';
      if(s.bg) slide.style.backgroundImage = `url('${s.bg}')`;
      slide.innerHTML = `<div class="slide-content">${s.img?`<img src="${s.img}" alt="${escapeHtml(s.alt||s.title||'Slide')}" loading="lazy" decoding="async" data-zoom="1">`:''}<div class="slide-text"><h2>${escapeHtml(s.title||'')}</h2>${s.caption?`<p>${escapeHtml(s.caption)}</p>`:''}<a class="cta" href="${s.btn_link||'#'}">${escapeHtml(s.btn_text||'Lihat')}</a></div></div>`;
      container.appendChild(slide);
    });
  }

  function renderProducts(){
    const grid = $('#productsGrid'); grid.innerHTML = '';
    if(!PRODUCTS.length){ grid.innerHTML = '<p>Tidak ada produk</p>'; return; }
    PRODUCTS.forEach(p=>{
      if(!p.aktif) return;
      const card = document.createElement('div'); card.className='card'; card.dataset.id = p.id || '';
      card.dataset.start = p.promostart || '';
      card.dataset.end = p.promoend || '';
      card.dataset.hargaawal = p.hargaawal || '';
      card.dataset.hargadiskon = p.hargadiskon || '';

      const promoLabel = document.createElement('div'); promoLabel.className='promo-label'; promoLabel.textContent='PROMO'; card.appendChild(promoLabel);
      const iw = document.createElement('div'); iw.className='img-wrapper';
      const img = document.createElement('img'); img.src = p.gbr || '/assets/noimage.png'; img.alt = p.alt || p.nama || 'Produk'; img.loading='lazy'; img.decoding='async'; img.setAttribute('data-zoom','1'); iw.appendChild(img);
      const co = document.createElement('div'); co.className='countdown-overlay'; co.style.display='none'; iw.appendChild(co);
      card.appendChild(iw);

      const title = document.createElement('h3'); title.textContent = p.nama; card.appendChild(title);
      if(p.desc){ const descEl = document.createElement('p'); descEl.className='product-desc'; const preview = String(p.desc).trim(); descEl.textContent = preview.length > 110 ? preview.slice(0,110)+'â€¦' : preview; card.appendChild(descEl); card.dataset.fulldesc = String(p.desc); }

      const priceWrap = document.createElement('div'); priceWrap.className='price'; const old = document.createElement('span'); old.className='old'; old.textContent = 'Rp ' + formatRupiah(p.hargaawal); const neu = document.createElement('span'); neu.className='new'; neu.textContent = 'Rp ' + formatRupiah(p.hargadiskon || p.hargaawal); priceWrap.appendChild(old); priceWrap.appendChild(neu); card.appendChild(priceWrap);

      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Tambah ke Keranjang'; btn.addEventListener('click', ()=> addToCartFromCard(card)); card.appendChild(btn);
      grid.appendChild(card);
    });
  }

  function renderGallery(){ const g=$('#galleryGrid'); g.innerHTML=''; if(!GALLERY.length) GALLERY=[{url:'/assets/gallery1.jpg',alt:'Galeri'}]; GALLERY.forEach(it=>{ const slide=document.createElement('div'); slide.className='swiper-slide gallery-item'; slide.innerHTML = `<img src="${it.url||''}" alt="${escapeHtml(it.alt||'Galeri')}" loading="lazy" decoding="async" data-zoom="1">`; g.appendChild(slide); }); }
  function renderTesti(){ const t=$('#testiGrid'); t.innerHTML=''; if(!TESTIS.length) TESTIS=[{nama:'Budi',jabatan:'Pelanggan',gambar:'/assets/user1.jpg',alt:'Testimoni'}]; TESTIS.forEach(it=>{ const slide=document.createElement('div'); slide.className='swiper-slide'; slide.innerHTML = `<div class="testimonial-card"><img src="${it.gambar||''}" alt="${escapeHtml(it.alt||it.nama||'Pelanggan')}" loading="lazy" decoding="async" data-zoom="1"><p><strong>${escapeHtml(it.nama||'')}</strong><br><small>${escapeHtml(it.jabatan||'')}</small></p></div>`; t.appendChild(slide); }); }

  function initSwipers(){ if(heroSwiper) heroSwiper.destroy(true,true); heroSwiper = new Swiper('#swiperHero', { loop:true, autoplay:{delay:5000,disableOnInteraction:false}, pagination:{el:'#swiperHero .swiper-pagination',clickable:true}, navigation:{nextEl:'#swiperHero .swiper-button-next',prevEl:'#swiperHero .swiper-button-prev'}, effect:'slide', grabCursor:true, keyboard:{enabled:true} }); if(gallerySwiper) gallerySwiper.destroy(true,true); gallerySwiper = new Swiper('#gallerySwiper', { loop:true, slidesPerView:1.2, spaceBetween:12, breakpoints:{480:{slidesPerView:2},640:{slidesPerView:3},900:{slidesPerView:4},1200:{slidesPerView:5}}, pagination:{el:'#gallerySwiper .swiper-pagination',clickable:true}, navigation:{nextEl:'#gallerySwiper .swiper-button-next',prevEl:'#gallerySwiper .swiper-button-prev'}, grabCursor:true }); if(testiSwiper) testiSwiper.destroy(true,true); testiSwiper = new Swiper('#testiSwiper', { slidesPerView:1.1,spaceBetween:12,loop:true, breakpoints:{640:{slidesPerView:2},900:{slidesPerView:3}}, pagination:{el:'#testiSwiper .swiper-pagination',clickable:true}, grabCursor:true }); }

  function updateCountdowns(){
    const cards = $$('#productsGrid .card');
    let anyPromo=false;
    cards.forEach(card=>{
      const co = $('.countdown-overlay', card);
      const promoLabel = $('.promo-label', card);
      const oldEl = $('.old', card);
      const newEl = $('.new', card);
      const start = (card.dataset.start||'').trim();
      const end = (card.dataset.end||'').trim();
      const hargaAwal = card.dataset.hargaawal || '';
      const hargaDiskon = card.dataset.hargadiskon || '';
      const {active, secondsLeft} = getPromoStatus(start, end);
      if(active && secondsLeft>0){ anyPromo=true; if(co) { co.textContent = formatHMS(secondsLeft); co.style.display='block'; } if(promoLabel) promoLabel.style.display='inline-block'; if(oldEl) oldEl.style.display = (hargaDiskon ? 'inline-block' : 'none'); if(newEl) newEl.textContent = 'Rp ' + formatRupiah(hargaDiskon||hargaAwal); } else { if(co) co.style.display='none'; if(promoLabel) promoLabel.style.display='none'; if(oldEl) oldEl.style.display='none'; if(newEl) newEl.textContent = 'Rp ' + formatRupiah(hargaAwal); }
    });
    const promoBar = $('#promo-bar'); promoBar.style.display = anyPromo ? 'block' : 'none'; document.documentElement.style.setProperty('--headerTop', anyPromo ? '36px' : '0px');
  }

  // cart functions unchanged
  function addToCartFromCard(card){ const id = card.dataset.id || ('tmp-'+Math.random().toString(36).slice(2,8)); const name = card.querySelector('h3')?.innerText || 'Produk'; const priceText = card.querySelector('.price .new')?.innerText || ''; const priceNum = Number(String(priceText).replace(/\D/g,'')) || Number(String(card.dataset.hargadiskon || card.dataset.hargaawal || 0).replace(/\D/g,'')) || 0; const existing = cart.find(i=>i.id===id); if(existing) existing.qty++; else cart.push({id, name, price:priceNum, qty:1}); updateCartUI(); }
  function updateCartUI(){ const count = cart.reduce((s,i)=>s+(i.qty||0),0); const badge = $('#cartBadge'); if(count>0){ badge.style.display='inline-block'; badge.textContent = count; } else { badge.style.display='none'; } renderCartPanel(); }
  function renderCartPanel(){ const list = $('#cartItemsList'); list.innerHTML=''; if(cart.length===0){ list.innerHTML='<p>Keranjang kosong</p>'; $('#cartTotal').textContent = 'Rp 0'; return; } let total=0; cart.forEach(it=>{ total += it.price * it.qty; const row = document.createElement('div'); row.className='cart-item'; row.innerHTML = `<div style="max-width:60%"><div style="font-weight:800">${escapeHtml(it.name)}</div><div style="font-size:.9rem;color:var(--muted)">Rp ${formatRupiah(it.price)} / pcs</div></div><div class="qty-controls" data-id="${it.id}"><button class="qty-btn" data-change="-1" aria-label="Kurangi">âˆ’</button><input type="number" value="${it.qty}" class="qty-input" style="width:45px;text-align:center;font-weight:800"><button class="qty-btn" data-change="1" aria-label="Tambah">+</button></div>`; list.appendChild(row); }); $('#cartTotal').textContent = 'Rp ' + formatRupiah(total); list.querySelectorAll('.qty-controls button').forEach(btn=>{ btn.removeEventListener('click', onQtyBtnClick); btn.addEventListener('click', onQtyBtnClick); }); list.querySelectorAll('.qty-input').forEach(inp=>{ inp.addEventListener('change', ()=>{ const id = inp.closest('.qty-controls').dataset.id; const item = cart.find(i=>i.id===id); if(item){ const v = parseInt(inp.value,10); item.qty = isNaN(v) || v<=0 ? 1 : v; updateCartUI(); } }); }); }
  function onQtyBtnClick(e){ const btn = e.currentTarget; const change = Number(btn.dataset.change||0); const parent = btn.closest('.qty-controls'); if(!parent) return; const id = parent.dataset.id; const item = cart.find(i=>i.id===id); if(!item) return; item.qty += change; if(item.qty <= 0) cart = cart.filter(i=>i.id!==id); updateCartUI(); }

  function setupUI(){ const darkOn = localStorage.getItem('dark')==='1'; if(darkOn) document.body.classList.add('dark'); syncCloseCartDark(); $('#menuToggle').addEventListener('click', ()=> { $('#offcanvasLeft').classList.add('active'); $('#offcanvasLeft').setAttribute('aria-hidden','false'); }); $('#offLeftClose').addEventListener('click', ()=> { $('#offcanvasLeft').classList.remove('active'); $('#offcanvasLeft').setAttribute('aria-hidden','true'); }); $$('.off-link').forEach(a=> a.addEventListener('click', ()=> $('#offcanvasLeft').classList.remove('active'))); $('#cartFloat').addEventListener('click', ()=> { $('#cartPanel').classList.add('active'); $('#cartPanel').setAttribute('aria-hidden','false'); renderCartPanel(); }); $('#closeCartPanel').addEventListener('click', ()=> { $('#cartPanel').classList.remove('active'); $('#cartPanel').setAttribute('aria-hidden','true'); }); $('#clearCart').addEventListener('click', ()=> { cart=[]; updateCartUI(); }); $('#checkoutBtn').addEventListener('click', ()=>{ if(!SETTINGS.wa){ alert('Nomor WhatsApp belum diatur.'); return; } if(cart.length===0){ alert('Keranjang masih kosong'); return; } let msg = 'Saya ingin memesan:%0A'; cart.forEach(i=> msg += `- ${i.name} x${i.qty} (Rp ${formatRupiah(i.price*i.qty)})%0A`); window.open(`https://wa.me/${SETTINGS.wa}?text=${msg}`, '_blank'); }); $('#darkToggle').addEventListener('click', ()=>{ const on = document.body.classList.toggle('dark'); localStorage.setItem('dark', on ? '1' : '0'); syncCloseCartDark(); }); const topBtn = $('#scrollTopBtn'); const checkTopBtn = ()=>{ if(window.scrollY > 200) topBtn.classList.add('visible'); else topBtn.classList.remove('visible'); }; window.addEventListener('scroll', checkTopBtn, {passive:true}); checkTopBtn(); topBtn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'})); document.body.addEventListener('click', (e)=>{ const img = e.target.closest('img[data-zoom]'); if(!img) return; const card = img.closest('.card'); if(card && card.dataset.fulldesc){ openProductModal(card); } else { openZoom(img.src, img.alt||'Gambar'); } }); $('#zoomClose').addEventListener('click', closeZoom); $('#zoomIn').addEventListener('click', ()=> setZoom(scale*1.2)); $('#zoomOut').addEventListener('click', ()=> setZoom(scale/1.2)); $('#zoomReset').addEventListener('click', ()=> { setZoom(1); setTranslate(0,0); }); setupRevealObserver(); }
  function syncCloseCartDark(){ const on = document.body.classList.contains('dark'); document.querySelectorAll('.close-cart').forEach(b=> b.classList.toggle('dark', on)); }

  // reveal observer, zoom vars (kept minimal here) ... (assume copied)

  async function loadArticles(){
    // Diubah: gunakan section 'Pemesanan Cepat' untuk menampilkan tombol order cepat
    const container = document.getElementById('blogList'); container.innerHTML = '';
    if(!PRODUCTS.length){ container.innerHTML = '<p>Belum ada produk</p>'; return; }
    PRODUCTS.forEach(p=>{
      if(!p.aktif) return;
      const card = document.createElement('div'); card.className='blog-card'; card.innerHTML = `<img src="${p.gbr||'/assets/noimage.png'}" alt="${escapeHtml(p.nama)}" loading="lazy" decoding="async"><div><h3>${escapeHtml(p.nama)}</h3><p>${escapeHtml(p.desc? (String(p.desc).slice(0,80)+'â€¦') : '')}</p><a href="#" class="btn-order" data-id="${p.id}">Order via WA</a></div>`;
      container.appendChild(card);
    });

    // populate popular list (quick menu)
    const pop = document.getElementById('popularList'); pop.innerHTML = '';
    PRODUCTS.slice(0,6).forEach(p=>{ if(!p.aktif) return; const li = document.createElement('li'); li.innerHTML = `<a href="#" class="btn-order" data-id="${p.id}" style="color:var(--accent)">${escapeHtml(p.nama)}</a>`; pop.appendChild(li); });

    // attach order handlers
    document.querySelectorAll('.btn-order').forEach(b=> b.addEventListener('click', (e)=>{ e.preventDefault(); const id = e.currentTarget.dataset.id; const prod = PRODUCTS.find(x=>x.id===id); if(!prod) return; const qty = 1; const msg = `Halo, saya mau pesan ${prod.nama} x${qty}`; window.open(`https://wa.me/${SETTINGS.wa}?text=${encodeURIComponent(msg)}`, '_blank'); }));
  }

  async function loadPopularArticles(){
    // keep for footer links but use PRODUCTS
    const list = document.getElementById('popularList'); if(!PRODUCTS.length){ list.innerHTML = '<li>Belum ada menu</li>'; return; } list.innerHTML=''; PRODUCTS.slice(0,6).forEach(r=>{ const li=document.createElement('li'); li.innerHTML = `<a href="#" style="color:var(--accent)">${escapeHtml(r.nama)}</a>`; list.appendChild(li); }); }

  // Purchase notification system
  let notifTimer = null;
  function startPurchaseNotifications(items){
    const toast = $('#purchaseToast'); if(!items || !items.length) return;
    function showOnce(){
      const p = items[Math.floor(Math.random()*items.length)];
      toast.innerHTML = `<strong>${escapeHtml(p.nama)}</strong> baru saja membeli <em>${escapeHtml(p.produk)}</em>`;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 5000);
    }
    // random first delay 3-8s, then every 8-18s show
    let delay = 3000 + Math.floor(Math.random()*5000);
    notifTimer = setInterval(()=>{
      showOnce();
    }, 12000);
    // initial
    setTimeout(showOnce, delay);
  }

  // ====== INIT ======
  (async function init(){
    showLoading(true);
    if(localStorage.getItem('dark')==='1') document.body.classList.add('dark');
    try{
      const force = /(^|[?&])refresh=1(&|$)/.test(location.search);
      const ALL = await getAllData({force});

      // SUPPORT: if Pengaturan is object form, convert to rows like original
      let settingsRows = ALL.Pengaturan || [];
      if(!Array.isArray(settingsRows) && typeof settingsRows === 'object'){
        // convert to array of {key,value}
        settingsRows = Object.keys(settingsRows).map(k=>({key:k, value:ALL.Pengaturan[k]}));
      }
      SETTINGS = rowsToMap(settingsRows);
      applySettings(SETTINGS);

      SLIDES = normalizeSlides(ALL.Slider || []);
      PRODUCTS = normalizeProducts(ALL.Produk || []);
      PRODUCTS = PRODUCTS.filter(p => !!p.aktif);
      GALLERY = normalizeGallery(ALL.Galeri || []);
      TESTIS = normalizeTestis(ALL.Testimoni || []);
      window.ARTICLES = (ALL.Artikel || []);

      renderHero(); renderProducts(); renderGallery(); renderTesti();
      await loadArticles(); await loadPopularArticles();
      initSwipers(); setupUI();

      setTimeout(()=>{
        $$('#productsGrid .card').forEach(el=> revealObserver.observe(el));
        $$('#galleryGrid img').forEach(img=> revealObserver.observe(img));
        $$('#testiGrid img').forEach(img=> revealObserver.observe(img));
        $$('#slidesContainer img').forEach(img=> revealObserver.observe(img));
      }, 50);

      updateCountdowns(); setInterval(updateCountdowns, 1000);

      // start purchase notifications if provided
      if(ALL.NotifikasiPembelian && Array.isArray(ALL.NotifikasiPembelian)){
        startPurchaseNotifications(ALL.NotifikasiPembelian);
      }

    } catch(err){
      console.error('Init error', err);
      alert('Gagal muat data. Pastikan file data.js terpasang dan struktur DB benar.');
    } finally { showLoading(false); }
  })();

  // LEGAL, product modal, zoom modal handlers - keep from original file
  // For brevity in this preview we assume these functions exist below as in your original file.

  </script>

  <!--
    =========================
    data.js (create this file next to the HTML)
    COPY-PASTE the block below into a file named `data.js` in the same folder as this HTML.
    You can edit values, add products, tags, notificaton entries there.
    =========================
  -->

  <!--
  // Begin data.js
  window.DB = {
    Pengaturan: [
      { key: 'site title', value: 'Navid Snack' },
      { key: 'logo', value: '/assets/logo.png' },
      { key: 'icon', value: '/assets/favicon.png' },
      { key: 'warna', value: '#c59b58' },
      { key: 'textpromo', value: 'ðŸ”¥ Promo Spesial Setiap Hari! ðŸ”¥' },
      { key: 'wa', value: '6281234567890' },
      { key: 'wa message', value: 'Halo Navid Snack, saya mau pesan...' },
      { key: 'alamat', value: 'Jl. Raya Utama No.1, Lamongan' },
      { key: 'jam buka', value: '08.00 - 17.00' },
      { key: 'deskripsi', value: 'Produsen snack lokal berkualitas dari Lamongan' },
      { key: 'maps', value: 'https://maps.google.com/?q=Lamongan' },
      { key: 'video_embed', value: 'https://www.youtube.com/embed/B5njr5BoGo8' },
      { key: 'keywords', value: ['navid snack','keripik pisang','corn milk drink','sari kemangi','kerupuk telur asin','snack lamongan'] }
    ],

    Slider: [
      { bg: '/assets/hero1.jpg', img: '/assets/keripik.jpg', alt: 'Keripik Pisang', title: 'Keripik Pisang Renyah', ket_slider: 'Camilan renyah dari pisang pilihan', tombol: 'Pesan Sekarang', tombol_link:'#products' },
      { bg: '/assets/hero2.jpg', img: '/assets/cornmilk.jpg', alt: 'Corn Milk Drink', title: 'Corn Milk Drink', ket_slider: 'Minuman jagung susu segar', tombol: 'Pesan', tombol_link:'#products' }
    ],

    Produk: [
      { id:'p1', namaproduk:'Keripik Pisang', gbrproduk:'/assets/keripik.jpg', altproduk:'Keripik Pisang', hargaawal:15000, hargadiskon:12000, jampromostart:'08:00', jampromoend:'17:00', deskripsi:'Keripik pisang manis gurih khas Navid Snack', aktif: '1' },
      { id:'p2', namaproduk:'Corn Milk Drink', gbrproduk:'/assets/cornmilk.jpg', altproduk:'Corn Milk Drink', hargaawal:10000, hargadiskon:8000, deskripsi:'Minuman jagung susu segar', aktif: '1' },
      { id:'p3', namaproduk:'Sari Kemangi', gbrproduk:'/assets/sarikemangi.jpg', altproduk:'Sari Kemangi', hargaawal:8000, hargadiskon:6500, deskripsi:'Minuman sari kemangi menyehatkan', aktif: '1' },
      { id:'p4', namaproduk:'Kerupuk Telur Asin', gbrproduk:'/assets/kerupuk.jpg', altproduk:'Kerupuk Telur Asin', hargaawal:12000, hargadiskon:10000, deskripsi:'Kerupuk renyah dengan rasa telur asin khas', aktif: '1' }
    ],

    Galeri: [
      { gambar_url:'/assets/gallery1.jpg', altgaleri:'Produksi Keripik' },
      { gambar_url:'/assets/gallery2.jpg', altgaleri:'Produksi Minuman' }
    ],

    Testimoni: [
      { nama:'Andi', jabatan:'Pelanggan', gambar_url:'/assets/user1.jpg', alt:'Andi' },
      { nama:'Siti', jabatan:'Pelanggan', gambar_url:'/assets/user2.jpg', alt:'Siti' }
    ],

    Artikel: [],

    NotifikasiPembelian: [
      { nama:'Andi', produk:'Keripik Pisang' },
      { nama:'Sinta', produk:'Corn Milk Drink' },
      { nama:'Rudi', produk:'Kerupuk Telur Asin' },
      { nama:'Maya', produk:'Sari Kemangi' }
    ]
  };
  // End data.js
  -->

</body>
</html>
